name: Codex Build (Phased PRs)

on:
  workflow_dispatch:
    inputs:
      phase:
        description: "Which phase to run"
        required: true
        type: choice
        options:
          - phase-1-foundation-db
          - phase-2-stripe-billing
          - phase-3-scheduling-maps-ops

jobs:
  codex:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable pnpm
        run: corepack enable

      - name: Install deps
        run: pnpm install

      - name: Run Codex
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: .github/codex/prompts/${{ github.event.inputs.phase }}.md
          output-file: codex-output.md
          safety-strategy: drop-sudo
          sandbox: workspace-write
          # Leave model empty to use Codex defaults (more robust across releases)
          effort: medium
          codex-args: '["--full-auto"]'

      - name: Lint / Typecheck / Build
        run: |
          pnpm lint
          pnpm typecheck
          pnpm build

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "codex: ${{ github.event.inputs.phase }}"
          title: "Codex: ${{ github.event.inputs.phase }}"
          body: |
            Generated by Codex using:
            - AGENTS.md
            - docs/BLUEPRINT.md
            - .github/codex/prompts/${{ github.event.inputs.phase }}.md
          branch: codex/${{ github.event.inputs.phase }}
